{"version":3,"file":"focus.js","sources":["../../../../src/utilities/focus.ts"],"sourcesContent":["import { isElementInViewport } from '@polaris/utilities/is-element-in-viewport';\n\ntype Filter = (element: Element) => void;\nexport type MouseUpBlurHandler = (event: MouseEvent) => void;\n\nconst FOCUSABLE_SELECTOR =\n  'a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not([aria-disabled=\"true\"]):not([tabindex=\"-1\"]):not(:disabled),*[tabindex]';\nconst KEYBOARD_FOCUSABLE_SELECTORS =\n  'a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not([aria-disabled=\"true\"]):not([tabindex=\"-1\"]):not(:disabled),*[tabindex]:not([tabindex=\"-1\"])';\nconst MENUITEM_FOCUSABLE_SELECTORS =\n  'a[role=\"menuitem\"],frame[role=\"menuitem\"],iframe[role=\"menuitem\"],input[role=\"menuitem\"]:not([type=hidden]):not(:disabled),select[role=\"menuitem\"]:not(:disabled),textarea[role=\"menuitem\"]:not(:disabled),button[role=\"menuitem\"]:not(:disabled),*[tabindex]:not([tabindex=\"-1\"])';\nexport const handleMouseUpByBlurring: MouseUpBlurHandler = (event) => {\n  const target = event.target as HTMLAnchorElement | HTMLButtonElement;\n  target.blur();\n};\n\nexport function nextFocusableNode(\n  node: HTMLElement,\n  filter?: Filter,\n): HTMLElement | Element | null {\n  const allFocusableElements = [\n    ...document.querySelectorAll(FOCUSABLE_SELECTOR),\n  ];\n  const sliceLocation = allFocusableElements.indexOf(node) + 1;\n  const focusableElementsAfterNode = allFocusableElements.slice(sliceLocation);\n\n  for (const focusableElement of focusableElementsAfterNode) {\n    if (\n      isElementInViewport(focusableElement) &&\n      // (!filter || (filter && filter(focusableElement)))\n      (!filter || (filter && Boolean(filter(focusableElement))))\n    ) {\n      return focusableElement;\n    }\n  }\n\n  return null;\n}\n\nexport function findFirstFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n): HTMLElement | null {\n  if (!onlyDescendants && matches(element, FOCUSABLE_SELECTOR)) {\n    return element;\n  }\n\n  return element.querySelector(FOCUSABLE_SELECTOR);\n}\n\n// Popover needs to be able to find its activator even if it is disabled, which FOCUSABLE_SELECTOR doesn't support.\nexport function findFirstFocusableNodeIncludingDisabled(\n  element: HTMLElement,\n): HTMLElement | null {\n  const focusableSelector = `a,button,frame,iframe,input:not([type=hidden]),select,textarea,*[tabindex]`;\n\n  if (matches(element, focusableSelector)) {\n    return element;\n  }\n\n  return element.querySelector(focusableSelector);\n}\n\nexport function focusFirstFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n) {\n  findFirstFocusableNode(element, onlyDescendants)?.focus();\n}\n\nexport function focusNextFocusableNode(node: HTMLElement, filter?: Filter) {\n  const nextFocusable = nextFocusableNode(node, filter);\n  if (nextFocusable && nextFocusable instanceof HTMLElement) {\n    nextFocusable.focus();\n    return true;\n  }\n\n  return false;\n}\n\nexport function findFirstKeyboardFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n): HTMLElement | null {\n  if (!onlyDescendants && matches(element, KEYBOARD_FOCUSABLE_SELECTORS)) {\n    return element;\n  }\n  return element.querySelector(KEYBOARD_FOCUSABLE_SELECTORS);\n}\n\nexport function focusFirstKeyboardFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n) {\n  const firstFocusable = findFirstKeyboardFocusableNode(\n    element,\n    onlyDescendants,\n  );\n  if (firstFocusable) {\n    firstFocusable.focus();\n    return true;\n  }\n\n  return false;\n}\n\nexport function findLastKeyboardFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n) {\n  if (!onlyDescendants && matches(element, KEYBOARD_FOCUSABLE_SELECTORS)) {\n    return element;\n  }\n  const allFocusable = element.querySelectorAll(KEYBOARD_FOCUSABLE_SELECTORS);\n  return allFocusable[allFocusable.length - 1] as HTMLElement | null;\n}\n\nexport function focusLastKeyboardFocusableNode(\n  element: HTMLElement,\n  onlyDescendants = true,\n) {\n  const lastFocusable = findLastKeyboardFocusableNode(element, onlyDescendants);\n  if (lastFocusable) {\n    lastFocusable.focus();\n    return true;\n  }\n\n  return false;\n}\n\nexport function wrapFocusPreviousFocusableMenuItem(\n  parentElement: HTMLElement,\n  currentFocusedElement: HTMLElement,\n) {\n  const allFocusableChildren = getMenuFocusableDescendants(parentElement);\n  const currentItemIdx = getCurrentFocusedElementIndex(\n    allFocusableChildren,\n    currentFocusedElement,\n  );\n  if (currentItemIdx === -1) {\n    allFocusableChildren[0].focus();\n  } else {\n    allFocusableChildren[\n      (currentItemIdx - 1 + allFocusableChildren.length) %\n        allFocusableChildren.length\n    ].focus();\n  }\n}\n\nexport function wrapFocusNextFocusableMenuItem(\n  parentElement: HTMLElement,\n  currentFocusedElement: HTMLElement,\n) {\n  const allFocusableChildren = getMenuFocusableDescendants(parentElement);\n  const currentItemIdx = getCurrentFocusedElementIndex(\n    allFocusableChildren,\n    currentFocusedElement,\n  );\n  if (currentItemIdx === -1) {\n    allFocusableChildren[0].focus();\n  } else {\n    allFocusableChildren[\n      (currentItemIdx + 1) % allFocusableChildren.length\n    ].focus();\n  }\n}\n\nfunction getMenuFocusableDescendants(\n  element: HTMLElement,\n): NodeListOf<HTMLElement> {\n  return element.querySelectorAll(\n    MENUITEM_FOCUSABLE_SELECTORS,\n  ) as NodeListOf<HTMLElement>;\n}\n\nfunction getCurrentFocusedElementIndex(\n  allFocusableChildren: NodeListOf<HTMLElement>,\n  currentFocusedElement: HTMLElement,\n): number {\n  let currentItemIdx = 0;\n\n  for (const focusableChild of allFocusableChildren) {\n    if (focusableChild === currentFocusedElement) {\n      break;\n    }\n    currentItemIdx++;\n  }\n  return currentItemIdx === allFocusableChildren.length ? -1 : currentItemIdx;\n}\n\nfunction matches(node: HTMLElement, selector: string) {\n  if (node.matches) {\n    return node.matches(selector);\n  }\n\n  const matches = (node.ownerDocument || document).querySelectorAll(selector);\n  let i = matches.length;\n  while (--i >= 0 && matches.item(i) !== node) return i > -1;\n}\n"],"names":["matches"],"mappings":"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"}